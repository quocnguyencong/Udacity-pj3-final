name: Azure Pipelines

# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml
trigger:
- main

# ToDo: Replace the agent pool name, if you are using Udacity Cloud lab. 
# Otherwise, comment out the line below. 
pool: myAgentPool

variables:
  python.version: '3.7.6'
  # ToDo: Replace the service connection name as used in the DevOps project settings
  azureServiceConnectionId: 'sc-final-project'
  # Project root folder. Point to the folder containing manage.py file.
  projectRoot: $(System.DefaultWorkingDirectory)
  # Environment name
  environmentName: 'staging-testing'

stages:
- stage: Selenium
  jobs:
  - job: SeleniumUITest
    steps:
    #--------------------------------------------#
    # Selenium (UI) Test Suite - Archive the package  
    # "ArchiveFiles@2" picks up the web package and archives it.
    - task: ArchiveFiles@2
      displayName: 'Archive UI Tests'
      inputs:
        rootFolderOrFile: '$(System.DefaultWorkingDirectory)/automatedtesting/selenium'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId)-uitests.zip'
    # Selenium Test Suite - Publish the package  
    - publish: $(Build.ArtifactStagingDirectory)/$(Build.BuildId)-uitests.zip   # Same as the archiveFile artifact above. 
      displayName: 'Upload Package'
      artifact: drop-uitests
      
    - task: DownloadPipelineArtifact@2
      displayName: 'download test script'
      inputs:
        artifact: drop-uitests
        path: $(System.DefaultWorkingDirectory)/download
      
    - task: CmdLine@2
      displayName: extract test script and run test
      inputs:
        script: |
          unzip -o $(System.DefaultWorkingDirectory)/download/$(Build.BuildId)-uitests.zip -d test-script
          mkdir selenium_log
          python3 -u test-script/login.py | tee selenium_log/test_result.log
          
    - task: PublishPipelineArtifact@1
      displayName: Publish test result log
      inputs:
        targetPath: '$(System.DefaultWorkingDirectory)/selenium_log/test_result.log'
        artifactName: 'drop-uitests-logs'
    
